<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Browse Listings — CCNY Exchange</title>
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <a class="skip-to-content" href="#main">Skip to content</a>

  <header class="site-header">
    <div class="wrap">
      <a class="brand" href="index.html">CCNY Exchange</a>
      <nav aria-label="Primary">
        <a class="nav-link" href="index.html">Home</a>
        <a class="nav-link active" aria-current="page" href="market.html">Browse</a>
        <a class="nav-link" href="sell.html">Sell an Item</a>
        <a class="nav-link" href="safety.html">Safety</a>
  <a class="nav-link" href="login.html">Log In</a>
  <a class="nav-link" href="user.html">Profile</a>
  <a class="nav-link" href="cart.html">Cart</a>
        <a class="btn btn-primary btn-sm" href="signup.html">Sign Up</a>
      </nav>
    </div>
  </header>

  <main id="main" class="container">
    <header class="page-header">
      <h1>Browse Listings</h1>
      <p class="muted">Sample data only. No backend — links are placeholders.</p>
    </header>

    <form class="toolbar" role="search" id="filters">
      <input id="q" class="input" type="search" placeholder="Search textbooks, electronics, dorm items…" aria-label="Search" />
      <select id="category" class="input" aria-label="Filter by category">
        <option value="">All Categories</option>
      </select>
      <select id="sort" class="input" aria-label="Sort by">
        <option value="newest">Newest</option>
        <option value="price-asc">Lowest Price</option>
        <option value="price-desc">Highest Price</option>
      </select>
    </form>

    <section id="results" class="grid" aria-live="polite"></section>
    <div id="no-results" style="display:none;text-align:center;margin-top:1rem" class="muted">No results — try a different search or reset filters.</div>

  <script>
      let DATA = [];
      (async function(){ try{ const res = await fetch('data/products.json'); if(res.ok){ const j = await res.json(); DATA = j.products || []; initCategories(); readURLParams(); applyFilters(); } else { console.error('products.json load failed'); } }catch(e){ console.error(e); } })();
      const qEl = document.getElementById('q');
      const catEl = document.getElementById('category');
      const sortEl = document.getElementById('sort');
      const formEl = document.getElementById('filters');
      const resultsEl = document.getElementById('results');
      const noResultsEl = document.getElementById('no-results');

      function initCategories(){
        const cats = Array.from(new Set(DATA.map(p=>p.category).filter(Boolean)));
        cats.forEach(c => { const opt = document.createElement('option'); opt.value = c; opt.textContent = c; catEl.appendChild(opt); });
  }

      function readURLParams(){
        const params = new URLSearchParams(location.search);
        const q = params.get('q') || '';
        const category = params.get('category') || '';
        const sort = params.get('sort') || '';
        if (q) qEl.value = q;
        if (category) catEl.value = category;
        if (sort) sortEl.value = sort;
      }

      function normalizeText(s){ return (s||'').toString().toLowerCase(); }

      function applyFilters(){
        const q = normalizeText(qEl.value);
        const category = catEl.value;
        const sort = sortEl.value;

        let out = DATA.filter(p => {
          if (category && p.category !== category) return false;
          if (!q) return true;
          const hay = [p.title, p.description, (p.tags||[]).join(' '), p.location].map(normalizeText).join(' ');
          return hay.indexOf(q) !== -1;
        });

        if (sort === 'newest') out.sort((a,b)=> new Date(b.created_at) - new Date(a.created_at));
        else if (sort === 'price-asc') out.sort((a,b)=> a.price_cents - b.price_cents);
        else if (sort === 'price-desc') out.sort((a,b)=> b.price_cents - a.price_cents);

        renderResults(out);
        try{
          const params = new URLSearchParams();
          if (q) params.set('q', qEl.value);
          if (category) params.set('category', category);
          if (sort) params.set('sort', sort);
          const newUrl = params.toString() ? `${location.pathname}?${params.toString()}` : location.pathname;
          history.replaceState(null, '', newUrl);
        } catch(e){}
      }

      function createCard(p){
        const a = document.createElement('article'); a.className = 'card';
        const img = document.createElement('div'); img.className = 'thumb'; img.setAttribute('aria-hidden','true');
        const initials = p.title.split(' ').slice(0,2).map(s=>s[0]).join('').toUpperCase();
        const svg = `data:image/svg+xml;utf8,` + encodeURIComponent(`<svg xmlns='http://www.w3.org/2000/svg' width='400' height='300'><rect width='100%' height='100%' fill='%23eef2ff'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' font-size='40' fill='%23334155' font-family='Arial, Helvetica, sans-serif'>${initials}</text></svg>`);
        img.style.backgroundImage = `url(${svg})`;
        img.style.backgroundSize = 'cover';

        const body = document.createElement('div'); body.className = 'card-body';
        const h3 = document.createElement('h3'); h3.className = 'card-title'; h3.textContent = p.title;
        const meta = document.createElement('p'); meta.className = 'muted'; meta.textContent = `${p.category} • ${p.location}`;
        const priceRow = document.createElement('div'); priceRow.className = 'price-row';
        const price = document.createElement('span'); price.className = 'price'; price.textContent = (p.price_cents/100).toLocaleString(undefined,{style:'currency',currency:p.currency||'USD'});
        const btn = document.createElement('a'); btn.className = 'btn btn-sm'; btn.href = `product.html?id=${encodeURIComponent(p.id)}`; btn.textContent = 'View';
        priceRow.appendChild(price); priceRow.appendChild(btn);

        body.appendChild(h3); body.appendChild(meta); body.appendChild(priceRow);
        a.appendChild(img); a.appendChild(body);
        return a;
      }

      function renderResults(list){
        resultsEl.innerHTML = '';
        if (!list.length){ noResultsEl.style.display = 'block'; return; }
        noResultsEl.style.display = 'none';
        list.forEach(p => { resultsEl.appendChild(createCard(p)); });
      }

      function debounce(fn, wait=150){ let t; return (...args)=>{ clearTimeout(t); t = setTimeout(()=>fn(...args), wait); }; }

      formEl.addEventListener('submit', (e) => { e.preventDefault(); applyFilters(); });

      qEl.addEventListener('input', debounce(applyFilters, 200));
      catEl.addEventListener('change', applyFilters);
      sortEl.addEventListener('change', applyFilters);

      
    </script>
  <script src="auth-ui.js"></script>
  </main>

  <footer class="site-footer">
    <div class="wrap">
      <p>Meet in public campus spaces. See <a href="safety.html">Safety & Policies</a>.</p>
    </div>
  </footer>
</body>
</html>
